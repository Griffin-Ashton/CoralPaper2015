#!/usr/bin/env Rscript

#This script plots a rarefaction curve and a PCoA plot using the colors in the origional taxonomic figure for data in the paper titled
#"Spatial homogeneity of bacterial communities associated with the surface mucus layer of the reef-building coral Acropora palmata" 
#Adam Rivers 2014-08-04
library(ggplot2)
library(XML)
library(argparser, quietly=TRUE)

p <- arg_parser("A script to plot Rarafaction curves and PCA")
p <- add_argument(p, "--distance", help="The weighted Unifrac distance matrix")
p <- add_argument(p, "--map", help="the mapping file")
p <- add_argument(p, "--rare", help="the rarafaction plot html page")
p <- add_argument(p, "--rareout", help="the name for the rarefaction PDF file to be generated")
p <- add_argument(p, "--pcaout", help="the name for the PCA PDF file to be generated")
argv <- parse_args(p)

# read rarefaction data generated by QIIME
#tables <- readHTMLTable("~/Desktop/corals/testresults/arare/alpha_rarefaction_plots/rarefaction_plots.html")
tables <- readHTMLTable(argv.rare)
data <- tables[[3]]
data <-data[690:length(data$Description),]
names(data) <- sub(" ", ".", names(data))
names(data) <- sub("/", "", names(data))
data[data=='nan']<-NA
data$SeqsSample <- as.integer(levels(data$SeqsSample))[data$SeqsSample]
data$PD_whole_tree.Ave. <- as.numeric(levels(data$PD_whole_tree.Ave.))[data$PD_whole_tree.Ave.]
data$PD_whole_tree.Err. <- as.numeric(levels(data$PD_whole_tree.Err.))[data$PD_whole_tree.Err.]
# These colors are the category colors from the taxonomy plot
group.colors<-c("#940c00","#ff4a3f","#ffbcb4","#4a6bff","#008000")


# plot the rarefaction curve using ggplot2
pdf(argv$rareout, width=7, height=7)
ggplot(data, aes(x=SeqsSample, y=PD_whole_tree.Ave., colour=Description)) + 
  geom_errorbar(aes(ymin=PD_whole_tree.Ave.-PD_whole_tree.Err., ymax=PD_whole_tree.Ave.+PD_whole_tree.Err.), width=50) +
  geom_line() +
  geom_point()+
  theme_bw()+
  ylab("Phylogenetic diversity (PD)")+
  xlab("Sequences per sample")+
  scale_colour_manual(values=group.colors)
dev.off()


##PLOT PCoA

#load weighted UniFrac PCoA data from QIIME
#pcoa<-read.table('/home/adam/Desktop/corals/results/20140424/bdiv_even200/weighted_unifrac_pc.txt',header=T, sep="\t")
pcoa<-read.table(argv$distance, header=T, sep="\t")

#load a cleaned up sample mapping file
#map<- read.table('/home/adam/Desktop/corals/results/20140804/Map20140805.txt', header=F, sep="\t")
map<- read.table(argv$map, header=F, sep="\t")
# Add categorical variables to the data
mapshort<-data.frame(map[,c(1,4,8)])
pcoa.merged<-merge(mapshort,pcoa, by.x="V1", by.y="pc.vector.number")
#Rename the environment variable 
names(pcoa.merged)[3]<-"Environment"
#Plot the PCoA plot 
pdf(argv$pcaout, width=7, height=7)
ggplot(pcoa.merged, aes(x=X1, y=X2, colour=Environment))  +
  geom_point(size=4) +
  theme_bw()+
  ylab("PC2 - Percent variation explained 26%")+
  xlab("PC1 - Percent variation explained 47%")+
  scale_colour_manual(values=group.colors)
dev.off()
